(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     66457,       1769]
NotebookOptionsPosition[     64436,       1697]
NotebookOutlinePosition[     64818,       1714]
CellTagsIndexPosition[     64775,       1711]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["Coordinates transformation", "Title",
 CellChangeTimes->{{3.680517689924705*^9, 3.680517695145154*^9}}],

Cell["\<\
This worksheet shows how to recall the equations needed for performing the \
coordinates transformation that gives the coordinates of a {X,Y,Z} point in a \
local reference frame that is centered on the point p1, has the X axis \
pointing towards p2, and the Y axis lying in the plane {p1,p2,p3}.
First, let\[CloseCurlyQuote]s set up a test environment: beacons are the \
three coordinates used by MarvelMind Dashboard for defining the global \
reference frame when setting up the system, while dots is a list of random \
points, whose first three elements (non-collinear!) are to be used for \
setting the new local reference frame.\
\>", "Text",
 CellChangeTimes->{{3.680517702402617*^9, 3.680518013874937*^9}}],

Cell[CellGroupData[{

Cell["Rationale", "Chapter",
 CellChangeTimes->{{3.6805184378507147`*^9, 3.680518439087364*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"r", " ", "=", " ", "0.05"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"h", " ", "=", " ", 
   RowBox[{"-", "0.4"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"pts", " ", "=", " ", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"0", ",", "0", ",", "h"}], "}"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"1", ",", " ", "0", ",", " ", "h"}], "}"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"0.01", ",", " ", "0.8", ",", " ", "h"}], "}"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"beacons", " ", "=", " ", 
   RowBox[{"{", 
    RowBox[{"Red", ",", " ", 
     RowBox[{"Sphere", "[", 
      RowBox[{
       RowBox[{"pts", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
       ",", " ", "r"}], "]"}], ",", "Green", ",", " ", 
     RowBox[{"Sphere", "[", 
      RowBox[{
       RowBox[{"pts", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], 
       ",", " ", "r"}], "]"}], ",", " ", "Blue", ",", " ", 
     RowBox[{"Sphere", "[", 
      RowBox[{
       RowBox[{"pts", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}], 
       ",", " ", "r"}], "]"}]}], "}"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.6804983965853033`*^9, 3.680498476333729*^9}, {
   3.680498884211503*^9, 3.68049893827804*^9}, {3.6804990785932913`*^9, 
   3.680499080832478*^9}, {3.680499128619952*^9, 3.680499140882655*^9}, {
   3.680499215889431*^9, 3.680499228873247*^9}, 3.680499613257606*^9, {
   3.680499647615479*^9, 3.68049977514625*^9}, {3.68049991096002*^9, 
   3.680499934043716*^9}, 3.6805046536248703`*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{"dots", " ", "=", " ", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"0.3", ",", " ", "0.2", ",", " ", "0"}], "}"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"0.33", ",", " ", "0.15", ",", " ", "0"}], "}"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"0.45", ",", " ", "0.4", ",", " ", "0.1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"0.48", ",", " ", "0.56", ",", " ", "0.2"}], "}"}]}], "}"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.6805001468941717`*^9, 3.680500215331265*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Graphics3D", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"beacons", ",", " ", "Orange", ",", " ", 
     RowBox[{"Point", "[", "dots", "]"}]}], "}"}], ",", " ", 
   RowBox[{"Axes", "->", "True"}], ",", " ", 
   RowBox[{"AxesLabel", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"\"\<X\>\"", ",", " ", "\"\<Y\>\"", ",", " ", "\"\<Z\>\""}], 
     "}"}]}], ",", " ", 
   RowBox[{"PlotRange", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"-", "0.5"}], ",", "0.5"}], "}"}]}]}], "]"}]], "Input",
 CellChangeTimes->{{3.680498509965493*^9, 3.680498529434538*^9}, {
   3.6804986007735147`*^9, 3.680498674900194*^9}, {3.680498731928502*^9, 
   3.680498740285985*^9}, {3.680498947381124*^9, 3.680498980152439*^9}, {
   3.6804990643608522`*^9, 3.680499090910636*^9}, {3.6804991495361567`*^9, 
   3.680499149593378*^9}, 3.680499239604892*^9, {3.680499295686363*^9, 
   3.680499457149255*^9}, {3.6804995066623583`*^9, 3.680499588752989*^9}, {
   3.680500225043283*^9, 3.680500248454371*^9}, {3.680500727498269*^9, 
   3.6805007288600063`*^9}}],

Cell[BoxData[
 Graphics3DBox[{{
    {RGBColor[1, 0, 0], SphereBox[{0, 0, -0.4}, 0.05]}, 
    {RGBColor[0, 1, 0], SphereBox[{1, 0, -0.4}, 0.05]}, 
    {RGBColor[0, 0, 1], SphereBox[{0.01, 0.8, -0.4}, 0.05]}}, 
   {RGBColor[1, 0.5, 0], 
    Point3DBox[{{0.3, 0.2, 0}, {0.33, 0.15, 0}, {0.45, 0.4, 0.1}, {0.48, 0.56,
       0.2}}]}},
  Axes->True,
  AxesLabel->{
    FormBox["\"X\"", TraditionalForm], 
    FormBox["\"Y\"", TraditionalForm], 
    FormBox["\"Z\"", TraditionalForm]},
  ImageSize->{504.9258510440578, 330.},
  PlotRange->{-0.5, 0.5},
  ViewPoint->{0.07569213541230002, -0.4960293560872875, 3.3463749907230005`},
  ViewVertical->{0.017778090489962935`, 0.5570766698033633, 
   1.0196882873425608`}]], "Output",
 CellChangeTimes->{{3.680498622671494*^9, 3.680498650335835*^9}, 
   3.680498740928894*^9, {3.680498963865217*^9, 3.680498981948889*^9}, {
   3.6804990674584303`*^9, 3.680499092686059*^9}, {3.680499135825762*^9, 
   3.68049914516775*^9}, {3.6804992326357822`*^9, 3.680499239893326*^9}, 
   3.6804993036932793`*^9, {3.6804993350493307`*^9, 3.680499408915601*^9}, {
   3.680499439538013*^9, 3.68049945785085*^9}, {3.680499513677005*^9, 
   3.6804996168537903`*^9}, {3.6804997143817263`*^9, 3.680499747436201*^9}, 
   3.680499778823763*^9, 3.680499936708745*^9, {3.680500238497197*^9, 
   3.680500249159938*^9}, 3.6805007296067867`*^9, 3.680502455410474*^9, 
   3.680504658104538*^9}]
}, Open  ]],

Cell["\<\
The transformation happens in three steps:
1. p1 is translated into the origin
2. rotation about Z so that p2 is aligned to X axis (angle a1)
3. rotation about X so that p3 lays on the XY plane (angle a2)
Note that a2 is calculated as the angle of the projection of p3 on YZ plane \
(updated after T0 and T1) and the Y plane.\
\>", "Text",
 CellChangeTimes->{{3.680518041000066*^9, 3.6805180932672367`*^9}, {
  3.680518137110448*^9, 3.6805182237920933`*^9}, {3.680518264766864*^9, 
  3.680518275779542*^9}, {3.680518313029077*^9, 3.68051838828137*^9}}],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"T0", " ", "=", " ", 
   RowBox[{"InverseFunction", "[", 
    RowBox[{"TranslationTransform", "[", 
     RowBox[{"dots", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
     "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a1", " ", "=", 
   RowBox[{"VectorAngle", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"dots", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], 
      "//", "T0"}], ",", 
     RowBox[{"{", 
      RowBox[{"1", ",", "0", ",", "0"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"T1", "=", 
   RowBox[{"RotationTransform", "[", 
    RowBox[{"a1", ",", 
     RowBox[{"{", 
      RowBox[{"0", ",", "0", ",", "1"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"a2", "=", 
   RowBox[{"VectorAngle", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{
        "dots", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}], "//", 
        
        RowBox[{"RightComposition", "[", 
         RowBox[{"T0", ",", " ", "T1"}], "]"}]}], ")"}], "*", " ", 
      RowBox[{"{", 
       RowBox[{"0", ",", " ", "1", ",", " ", "1"}], "}"}]}], ",", 
     RowBox[{"{", 
      RowBox[{"0", ",", "1", ",", "0"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"T2", "=", 
   RowBox[{"RotationTransform", "[", 
    RowBox[{
     RowBox[{"-", "a2"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"1", ",", "0", ",", "0"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"Graphics3D", "[", 
  RowBox[{
   RowBox[{"{", "\[IndentingNewLine]", 
    RowBox[{"beacons", ",", " ", "\[IndentingNewLine]", "Orange", ",", " ", 
     RowBox[{"Point", "[", "dots", "]"}], ",", " ", "\[IndentingNewLine]", 
     "Blue", ",", " ", 
     RowBox[{"Point", "[", 
      RowBox[{"dots", "//", "T0"}], "]"}], ",", "\[IndentingNewLine]", 
     "Green", ",", " ", 
     RowBox[{"Point", "[", 
      RowBox[{"dots", "//", 
       RowBox[{"RightComposition", "[", 
        RowBox[{"T0", ",", " ", "T1"}], "]"}]}], "]"}], ",", 
     "\[IndentingNewLine]", "Red", ",", 
     RowBox[{"Opacity", "[", "0.5", "]"}], ",", " ", 
     RowBox[{"PointSize", "[", "Large", "]"}], ",", 
     RowBox[{"Point", "[", 
      RowBox[{"dots", "//", 
       RowBox[{"RightComposition", "[", 
        RowBox[{"T0", ",", " ", "T1", ",", " ", "T2"}], "]"}]}], "]"}], ",", 
     "\[IndentingNewLine]", "Green", ",", "\[IndentingNewLine]", 
     RowBox[{"Opacity", "[", "0.01", "]"}], ",", 
     RowBox[{"InfinitePlane", "[", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "1"}], "}"}]}], "}"}], "]"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"Opacity", "[", "0.01", "]"}], ",", 
     RowBox[{"InfinitePlane", "[", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "1", ",", "0"}], "}"}]}], "}"}], "]"}]}], 
    "\[IndentingNewLine]", "}"}], ",", " ", 
   RowBox[{"Axes", "->", "True"}], ",", " ", 
   RowBox[{"AxesLabel", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"\"\<X\>\"", ",", " ", "\"\<Y\>\"", ",", " ", "\"\<Z\>\""}], 
     "}"}]}], ",", " ", 
   RowBox[{"PlotRange", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"-", "0.5"}], ",", "0.5"}], "}"}]}]}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{"dots", "//", 
  RowBox[{"RightComposition", "[", 
   RowBox[{"T0", ",", " ", "T1", ",", "T2"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TransformationMatrix", "[", 
   RowBox[{"RightComposition", "[", 
    RowBox[{"T0", ",", " ", "T1", ",", "T2"}], "]"}], "]"}], "//", 
  "MatrixForm"}]}], "Input",
 CellChangeTimes->{{3.680507291448778*^9, 3.680507393352105*^9}, {
   3.68050746432998*^9, 3.6805074692124453`*^9}, {3.680507738700568*^9, 
   3.68050774096172*^9}, {3.680507772430007*^9, 3.6805077957833633`*^9}, {
   3.6805079245990753`*^9, 3.680508061794066*^9}, 3.680508105807659*^9, {
   3.680508174388838*^9, 3.6805081753195467`*^9}, {3.6805082189483843`*^9, 
   3.6805082416788263`*^9}, {3.6805082927767143`*^9, 
   3.6805082989154778`*^9}, {3.6805083871421824`*^9, 3.680508461738461*^9}, {
   3.680508921294106*^9, 3.68050892278564*^9}}],

Cell[BoxData[
 Graphics3DBox[{{
    {RGBColor[1, 0, 0], SphereBox[{0, 0, -0.4}, 0.05]}, 
    {RGBColor[0, 1, 0], SphereBox[{1, 0, -0.4}, 0.05]}, 
    {RGBColor[0, 0, 1], SphereBox[{0.01, 0.8, -0.4}, 0.05]}}, 
   {RGBColor[1, 0.5, 0], 
    Point3DBox[{{0.3, 0.2, 0}, {0.33, 0.15, 0}, {0.45, 0.4, 0.1}, {0.48, 0.56,
       0.2}}]}, 
   {RGBColor[0, 0, 1], 
    Point3DBox[{{0., 0., 0.}, {0.030000000000000027`, -0.05000000000000002, 
     0.}, {0.15000000000000002`, 0.2, 0.1}, {0.18, 0.36000000000000004`, 
     0.2}}]}, 
   {RGBColor[0, 1, 0], 
    Point3DBox[{{0., 0., 0.}, {0.058309518948453015`, -5.551115123125783*^-17,
      0.}, {-0.0943242218283798, 0.23152308994238696`, 
     0.1}, {-0.21608821727956112`, 0.3395671985821675, 0.2}}]}, 
   {RGBColor[1, 0, 0], PointSize[Large], Opacity[0.5], 
    Point3DBox[{{0., -5.551115123125783*^-17, 0.}, {0.058309518948453015`, 0.,
      0.}, {-0.0943242218283798, 
     0.25219623545261455`, -1.1102230246251565`*^-16}, {-0.21608821727956112`,
      0.39103536530525623`, 0.048961468866099145`}}], 
    {RGBColor[0, 1, 0], Opacity[0.01], 
     TagBox[ConicHullRegion3DBox[{{0, 0, 0}, {1, 0, 0}, {0, 0, 1}}],
      "InfinitePlane"], 
     {Opacity[0.01], 
      TagBox[ConicHullRegion3DBox[{{0, 0, 0}, {1, 0, 0}, {0, 1, 0}}],
       "InfinitePlane"]}}}},
  Axes->True,
  AxesLabel->{
    FormBox["\"X\"", TraditionalForm], 
    FormBox["\"Y\"", TraditionalForm], 
    FormBox["\"Z\"", TraditionalForm]},
  ImageSize->{692.9998987474303, 616.},
  PlotRange->{-0.5, 0.5},
  ViewPoint->{-0.14510733139987664`, -1.1527872585156027`, 
   3.1780537124123764`},
  ViewVertical->{-0.08993959998162543, 0.781362803714105, 
   1.0902648440379616`}]], "Output",
 CellChangeTimes->{
  3.680507470412012*^9, 3.680507959302704*^9, {3.680507990863638*^9, 
   3.6805080369794197`*^9}, {3.6805080893388233`*^9, 3.680508106989883*^9}, 
   3.680508176119774*^9, {3.680508232080171*^9, 3.680508242241768*^9}, 
   3.6805083002634687`*^9, 3.680508404281156*^9, {3.680508436978293*^9, 
   3.680508462500139*^9}, 3.6805089244402447`*^9}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"0.`", ",", 
     RowBox[{"-", "5.551115123125783`*^-17"}], ",", "0.`"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"0.058309518948453015`", ",", "0.`", ",", "0.`"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"-", "0.0943242218283798`"}], ",", "0.25219623545261455`", ",", 
     RowBox[{"-", "1.1102230246251565`*^-16"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"-", "0.21608821727956112`"}], ",", "0.39103536530525623`", ",", 
     "0.048961468866099145`"}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{
  3.680507470412012*^9, 3.680507959302704*^9, {3.680507990863638*^9, 
   3.6805080369794197`*^9}, {3.6805080893388233`*^9, 3.680508106989883*^9}, 
   3.680508176119774*^9, {3.680508232080171*^9, 3.680508242241768*^9}, 
   3.6805083002634687`*^9, 3.680508404281156*^9, {3.680508436978293*^9, 
   3.680508462500139*^9}, 3.6805089244498262`*^9}],

Cell[BoxData[
 TagBox[
  RowBox[{"(", "\[NoBreak]", GridBox[{
     {"0.5144957554275267`", 
      RowBox[{"-", "0.8574929257125441`"}], "0.`", "0.017149858514250826`"},
     {"0.7872021222220336`", "0.4723212733332204`", "0.3965166245266544`", 
      RowBox[{"-", "0.3306248913332542`"}]},
     {
      RowBox[{"-", "0.34001020045902325`"}], 
      RowBox[{"-", "0.204006120275414`"}], "0.9180275412393618`", 
      "0.1428042841927898`"},
     {"0.`", "0.`", "0.`", "1.`"}
    },
    GridBoxAlignment->{
     "Columns" -> {{Center}}, "ColumnsIndexed" -> {}, "Rows" -> {{Baseline}}, 
      "RowsIndexed" -> {}},
    GridBoxSpacings->{"Columns" -> {
        Offset[0.27999999999999997`], {
         Offset[0.7]}, 
        Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
        Offset[0.2], {
         Offset[0.4]}, 
        Offset[0.2]}, "RowsIndexed" -> {}}], "\[NoBreak]", ")"}],
  Function[BoxForm`e$, 
   MatrixForm[BoxForm`e$]]]], "Output",
 CellChangeTimes->{
  3.680507470412012*^9, 3.680507959302704*^9, {3.680507990863638*^9, 
   3.6805080369794197`*^9}, {3.6805080893388233`*^9, 3.680508106989883*^9}, 
   3.680508176119774*^9, {3.680508232080171*^9, 3.680508242241768*^9}, 
   3.6805083002634687`*^9, 3.680508404281156*^9, {3.680508436978293*^9, 
   3.680508462500139*^9}, 3.680508924455805*^9}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Generalization", "Chapter",
 CellChangeTimes->{{3.68051845213846*^9, 3.680518456063743*^9}}],

Cell["\<\
We now repeat the above for three general points p1, p2, and p3.\
\>", "Text",
 CellChangeTimes->{{3.680518468123962*^9, 3.6805184903207293`*^9}}],

Cell[BoxData[{
 RowBox[{"Clear", "[", 
  RowBox[{"T0", ",", "T1", ",", "T2", ",", " ", "a1", ",", " ", "a2"}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"T0", "[", "p_", "]"}], " ", ":=", " ", 
   RowBox[{"InverseFunction", "[", 
    RowBox[{"TranslationTransform", "[", "p", "]"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"a1", "[", 
    RowBox[{"p1_", ",", " ", "p2_"}], "]"}], " ", ":=", 
   RowBox[{"VectorAngle", "[", 
    RowBox[{
     RowBox[{"p2", "//", 
      RowBox[{"T0", "[", "p1", "]"}]}], ",", 
     RowBox[{"{", 
      RowBox[{"1", ",", "0", ",", "0"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"T1", "[", 
    RowBox[{"p1_", ",", "p2_"}], "]"}], ":=", 
   RowBox[{"RotationTransform", "[", 
    RowBox[{
     RowBox[{"a1", "[", 
      RowBox[{"p1", ",", "p2"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"0", ",", "0", ",", "1"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"a2", "[", 
    RowBox[{"p1_", ",", "p2_", ",", "p3_"}], "]"}], ":=", 
   RowBox[{"VectorAngle", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"(", 
       RowBox[{"p3", "//", 
        RowBox[{"RightComposition", "[", 
         RowBox[{
          RowBox[{"T0", "[", "p1", "]"}], ",", " ", 
          RowBox[{"T1", "[", 
           RowBox[{"p1", ",", "p2"}], "]"}]}], "]"}]}], ")"}], "*", " ", 
      RowBox[{"{", 
       RowBox[{"0", ",", " ", "1", ",", " ", "1"}], "}"}]}], ",", 
     RowBox[{"{", 
      RowBox[{"0", ",", "1", ",", "0"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"T2", "[", 
    RowBox[{"p1_", ",", "p2_", ",", "p3_"}], "]"}], ":=", 
   RowBox[{"RotationTransform", "[", 
    RowBox[{
     RowBox[{"-", 
      RowBox[{"a2", "[", 
       RowBox[{"p1", ",", "p2", ",", "p3"}], "]"}]}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"1", ",", "0", ",", "0"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TT", "[", 
   RowBox[{"p1_", ",", "p2_", ",", "p3_"}], "]"}], ":=", 
  RowBox[{"RightComposition", "[", 
   RowBox[{
    RowBox[{"T0", "[", "p1", "]"}], ",", 
    RowBox[{"T1", "[", 
     RowBox[{"p1", ",", "p2"}], "]"}], ",", 
    RowBox[{"T2", "[", 
     RowBox[{"p1", ",", "p2", ",", "p3"}], "]"}]}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.6805085122429943`*^9, 3.6805085183050413`*^9}, {
  3.680508554970911*^9, 3.680508756561604*^9}, {3.6805092767419767`*^9, 
  3.68050928415315*^9}, {3.680509389727222*^9, 3.680509405104436*^9}, {
  3.680509669316807*^9, 3.680509727108163*^9}}],

Cell["Now check for consistency with the above on the same data:", "Text",
 CellChangeTimes->{{3.680518527086228*^9, 3.680518540091634*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Graphics3D", "[", 
  RowBox[{
   RowBox[{"{", "\[IndentingNewLine]", 
    RowBox[{"beacons", ",", " ", "\[IndentingNewLine]", "Orange", ",", " ", 
     RowBox[{"Point", "[", "dots", "]"}], ",", " ", "\[IndentingNewLine]", 
     "Blue", ",", " ", 
     RowBox[{"Point", "[", 
      RowBox[{"dots", "//", 
       RowBox[{"T0", "[", 
        RowBox[{
        "dots", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
        "]"}]}], "]"}], ",", "\[IndentingNewLine]", "Green", ",", " ", 
     RowBox[{"Point", "[", 
      RowBox[{"dots", "//", 
       RowBox[{"RightComposition", "[", 
        RowBox[{
         RowBox[{"T0", "[", 
          RowBox[{
          "dots", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
          "]"}], ",", " ", 
         RowBox[{"T1", "[", 
          RowBox[{
           RowBox[{
           "dots", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
           ",", 
           RowBox[{
           "dots", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}], 
          "]"}]}], "]"}]}], "]"}], ",", "\[IndentingNewLine]", "Red", ",", 
     RowBox[{"Opacity", "[", "0.5", "]"}], ",", " ", 
     RowBox[{"PointSize", "[", "Large", "]"}], ",", 
     RowBox[{"Point", "[", 
      RowBox[{"dots", "//", 
       RowBox[{"TT", "[", 
        RowBox[{
         RowBox[{
         "dots", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], ",", 
         
         RowBox[{
         "dots", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], ",", 
         
         RowBox[{
         "dots", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}]}], 
        "]"}]}], "]"}], ",", "\[IndentingNewLine]", "Green", ",", 
     "\[IndentingNewLine]", 
     RowBox[{"Opacity", "[", "0.01", "]"}], ",", 
     RowBox[{"InfinitePlane", "[", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "1"}], "}"}]}], "}"}], "]"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"Opacity", "[", "0.01", "]"}], ",", 
     RowBox[{"InfinitePlane", "[", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"0", ",", "1", ",", "0"}], "}"}]}], "}"}], "]"}]}], 
    "\[IndentingNewLine]", "}"}], ",", " ", 
   RowBox[{"Axes", "->", "True"}], ",", " ", 
   RowBox[{"AxesLabel", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"\"\<X\>\"", ",", " ", "\"\<Y\>\"", ",", " ", "\"\<Z\>\""}], 
     "}"}]}], ",", " ", 
   RowBox[{"PlotRange", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"-", "0.5"}], ",", "0.5"}], "}"}]}]}], "]"}]], "Input",
 CellChangeTimes->{{3.6805144870615997`*^9, 3.680514505982815*^9}}],

Cell[BoxData[
 Graphics3DBox[{{
    {RGBColor[1, 0, 0], SphereBox[{0, 0, -0.4}, 0.05]}, 
    {RGBColor[0, 1, 0], SphereBox[{1, 0, -0.4}, 0.05]}, 
    {RGBColor[0, 0, 1], SphereBox[{0.01, 0.8, -0.4}, 0.05]}}, 
   {RGBColor[1, 0.5, 0], 
    Point3DBox[{{0.3, 0.2, 0}, {0.33, 0.15, 0}, {0.45, 0.4, 0.1}, {0.48, 0.56,
       0.2}}]}, 
   {RGBColor[0, 0, 1], 
    Point3DBox[{{0., 0., 0.}, {0.030000000000000027`, -0.05000000000000002, 
     0.}, {0.15000000000000002`, 0.2, 0.1}, {0.18, 0.36000000000000004`, 
     0.2}}]}, 
   {RGBColor[0, 1, 0], 
    Point3DBox[{{0., 0., 0.}, {0.058309518948453015`, -5.551115123125783*^-17,
      0.}, {-0.0943242218283798, 0.23152308994238696`, 
     0.1}, {-0.21608821727956112`, 0.3395671985821675, 0.2}}]}, 
   {RGBColor[1, 0, 0], PointSize[Large], Opacity[0.5], 
    Point3DBox[{{0., -5.551115123125783*^-17, 0.}, {0.058309518948453015`, 0.,
      0.}, {-0.0943242218283798, 
     0.25219623545261455`, -1.1102230246251565`*^-16}, {-0.21608821727956112`,
      0.39103536530525623`, 0.048961468866099145`}}], 
    {RGBColor[0, 1, 0], Opacity[0.01], 
     TagBox[ConicHullRegion3DBox[{{0, 0, 0}, {1, 0, 0}, {0, 0, 1}}],
      "InfinitePlane"], 
     {Opacity[0.01], 
      TagBox[ConicHullRegion3DBox[{{0, 0, 0}, {1, 0, 0}, {0, 1, 0}}],
       "InfinitePlane"]}}}},
  Axes->True,
  AxesLabel->{
    FormBox["\"X\"", TraditionalForm], 
    FormBox["\"Y\"", TraditionalForm], 
    FormBox["\"Z\"", TraditionalForm]},
  ImageSize->{325.8705609708621, 298.1810922526852},
  PlotRange->{-0.5, 0.5},
  ViewPoint->{0.5246505894953131, -2.976974674646756, 1.5206457659343493`},
  ViewVertical->{0.001164978200953383, -0.23645307375499894`, 
   1.300077643990591}]], "Output",
 CellChangeTimes->{{3.680509341675922*^9, 3.68050935778759*^9}, 
   3.6805145092851954`*^9}]
}, Open  ]],

Cell[TextData[{
 "The TransformationFunction ",
 StyleBox["TT[p1_, p2_, p3_]", "Input"],
 " represents the homogenous transformation matrix that, multiplied by a \
general point",
 StyleBox[" {X,Y,Z,1}", "Input"],
 ", gives the coordinates of the point in the local reference frame.\nFor \
efficiency in calculation, though we need to do some simplification:"
}], "Text",
 CellChangeTimes->{{3.6805186306793423`*^9, 3.680518750910421*^9}, {
  3.6805187840986347`*^9, 3.680518819345417*^9}}],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"rules", " ", "=", 
   RowBox[{"{", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"p1x", "+", "p2x"}], "\[Rule]", "p1x2x"}], ",", 
     RowBox[{
      RowBox[{"p1x", "-", "p2x"}], "\[Rule]", "p2x1x"}], ",", 
     RowBox[{
      RowBox[{
       RowBox[{"-", "p1x"}], "+", "p2x"}], "\[Rule]", 
      RowBox[{"-", "p2x1x"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"p1y", "+", "p2y"}], "\[Rule]", "p1y2y"}], ",", 
     RowBox[{
      RowBox[{"p1y", "-", "p2y"}], "\[Rule]", "p2y1y"}], ",", 
     RowBox[{
      RowBox[{
       RowBox[{"-", "p1y"}], "+", "p2y"}], "\[Rule]", 
      RowBox[{"-", "p2y1y"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"p1z", "+", "p2z"}], "\[Rule]", "p1z2z"}], ",", 
     RowBox[{
      RowBox[{"p1z", "-", "p2z"}], "\[Rule]", "p2z1z"}], ",", 
     RowBox[{
      RowBox[{
       RowBox[{"-", "p1z"}], "+", "p2z"}], "\[Rule]", 
      RowBox[{"-", "p2z1z"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       SuperscriptBox["p2x1x", "2"], "+", 
       SuperscriptBox["p2y1y", "2"], "+", 
       SuperscriptBox["p2z1z", "2"]}], " ", "\[Rule]", " ", "p21"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"p1z", "-", "p3z"}], " ", "\[Rule]", " ", "p3z1z"}], ",", " ", 
     RowBox[{
      RowBox[{
       RowBox[{"-", "p1z"}], "+", "p3z"}], " ", "\[Rule]", " ", 
      RowBox[{"-", "p3z1z"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Sqrt", "[", 
       RowBox[{
        SuperscriptBox["p1y", "2"], "+", 
        SuperscriptBox["p1z", "2"], "-", 
        RowBox[{"2", " ", "p1y", " ", "p2y"}], "+", 
        SuperscriptBox["p2y", "2"], "-", 
        RowBox[{"2", " ", "p1z", " ", "p2z"}], "+", 
        SuperscriptBox["p2z", "2"]}], "]"}], "\[Rule]", "psq"}]}], 
    "\[IndentingNewLine]", "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"TTs", "=", 
  RowBox[{
   RowBox[{"Simplify", "[", 
    RowBox[{
     RowBox[{"TT", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"p1x", ",", "p1y", ",", "p1z"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"p2x", ",", "p2y", ",", "p2z"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"p3x", ",", "p3y", ",", "p3z"}], "}"}]}], "]"}], ",", " ", 
     RowBox[{"Element", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "p1x", ",", "p1y", ",", "p1z", ",", "p2x", ",", "p2y", ",", "p2z", 
         ",", "p3x", ",", "p3y", ",", "p3z"}], "}"}], ",", "Reals"}], "]"}]}],
     "]"}], "//.", "rules"}]}]}], "Input",
 CellChangeTimes->CompressedData["
1:eJwdxU0ogwEABuA1+yk1q+26zGZjYmW11hSfVlYbY5GD2lZjVsbKSnZwUdtk
tZJpiakxUrv428Fp2drKsliW0lIitiQHGWLK+N4dnh7B2PSQlUqhUHgknJvV
lGn2FxWVJvjDjosAi06ue8vy8FKiWYgPuQNNePXnXIWdKa0aa11RLc7niF6s
yQX1mJtuHMGeh3ojZvV8WXHIcOvACmXai+20ih/fcC43qvPFYZw0XFV3m6R7
WN6RPMKxM10cO07MSTz56qczyCOlOyauFC1sTKuZ42Kzbl6AC99sIQ5kDRKc
c7a14u16IYGjfQw1dskto3h3/3oKOxcJL860M3xYpPctYyUhXsG2YdMaDtX+
ruPSweMWnpEu7OC6T2kEJzyCY2x84sewW2bL4PuiIosnNk/zOFiWNDDJOe/h
FtyZEsnwRyVRfbD/uQsXxuPd+B+TcMgI
  "]],

Cell[BoxData[
 RowBox[{"TransformationFunction", "[", 
  RowBox[{"(", 
   TagBox[GridBox[{
      {
       RowBox[{"-", 
        FractionBox["p2x1x", 
         SqrtBox["p21"]]}], 
       RowBox[{"-", 
        SqrtBox[
         RowBox[{"1", "-", 
          FractionBox[
           SuperscriptBox["p2x1x", "2"], "p21"]}]]}], "0", 
       FractionBox[
        RowBox[{
         SuperscriptBox["p1x", "2"], "-", 
         RowBox[{"p1x", " ", "p2x"}], "+", 
         RowBox[{"p1y", " ", "psq"}]}], 
        SqrtBox["p21"]]},
      {
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
          RowBox[{"p2x", " ", "p3y"}], "+", 
          RowBox[{"p3x", " ", "psq"}], "-", 
          RowBox[{"p1x", " ", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], ")"}],
         "/", 
        RowBox[{"(", 
         RowBox[{"\[Sqrt]", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              SuperscriptBox[
               RowBox[{"(", 
                RowBox[{
                 SuperscriptBox["p1x", "2"], "+", 
                 SuperscriptBox["p1y", "2"], "+", 
                 SuperscriptBox["p1z", "2"], "-", 
                 RowBox[{"2", " ", "p1x", " ", "p2x"}], "+", 
                 SuperscriptBox["p2x", "2"], "-", 
                 RowBox[{"2", " ", "p1y", " ", "p2y"}], "+", 
                 SuperscriptBox["p2y", "2"], "-", 
                 RowBox[{"2", " ", "p1z", " ", "p2z"}], "+", 
                 SuperscriptBox["p2z", "2"]}], ")"}], "2"], " ", 
              RowBox[{"(", 
               RowBox[{
                SuperscriptBox["p3z1z", "2"], "+", 
                SuperscriptBox[
                 RowBox[{"Abs", "[", 
                  FractionBox[
                   RowBox[{
                    RowBox[{
                    RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
                    RowBox[{"p2x", " ", "p3y"}], "+", 
                    RowBox[{"p3x", " ", "psq"}], "-", 
                    RowBox[{"p1x", " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
                   SqrtBox["p21"]], "]"}], "2"]}], ")"}]}], ")"}], "/", 
            RowBox[{"(", 
             RowBox[{
              SuperscriptBox["p1y", "2"], "+", 
              SuperscriptBox["p1z", "2"], "-", 
              RowBox[{"2", " ", "p1y", " ", "p2y"}], "+", 
              SuperscriptBox["p2y", "2"], "-", 
              RowBox[{"2", " ", "p1z", " ", "p2z"}], "+", 
              SuperscriptBox["p2z", "2"]}], ")"}]}], ")"}]}], ")"}]}], 
       FractionBox[
        RowBox[{"p2x1x", " ", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"p1y", " ", "p2x"}], "-", 
           RowBox[{"p2x", " ", "p3y"}], "-", 
           RowBox[{"p3x", " ", "psq"}], "+", 
           RowBox[{"p1x", " ", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
          ")"}]}], 
        RowBox[{"p21", " ", 
         SqrtBox[
          RowBox[{
           SuperscriptBox["p3z1z", "2"], "+", 
           SuperscriptBox[
            RowBox[{"Abs", "[", 
             FractionBox[
              RowBox[{
               RowBox[{
                RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
               RowBox[{"p2x", " ", "p3y"}], "+", 
               RowBox[{"p3x", " ", "psq"}], "-", 
               RowBox[{"p1x", " ", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
              SqrtBox["p21"]], "]"}], "2"]}]]}]], 
       SqrtBox[
        RowBox[{"1", "-", 
         FractionBox[
          SuperscriptBox[
           RowBox[{"(", 
            RowBox[{
             RowBox[{"p1y", " ", "p2x"}], "-", 
             RowBox[{"p2x", " ", "p3y"}], "-", 
             RowBox[{"p3x", " ", "psq"}], "+", 
             RowBox[{"p1x", " ", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
            ")"}], "2"], 
          RowBox[{"p21", " ", 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["p3z1z", "2"], "+", 
             SuperscriptBox[
              RowBox[{"Abs", "[", 
               FractionBox[
                RowBox[{
                 RowBox[{
                  RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
                 RowBox[{"p2x", " ", "p3y"}], "+", 
                 RowBox[{"p3x", " ", "psq"}], "-", 
                 RowBox[{"p1x", " ", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
                SqrtBox["p21"]], "]"}], "2"]}], ")"}]}]]}]], 
       RowBox[{
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"p1y", " ", "p2x"}], "+", 
            RowBox[{"p1x", " ", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"-", "p1y"}], "+", "psq"}], ")"}]}]}], ")"}], " ", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"p1y", " ", "p2x"}], "-", 
            RowBox[{"p2x", " ", "p3y"}], "-", 
            RowBox[{"p3x", " ", "psq"}], "+", 
            RowBox[{"p1x", " ", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
           ")"}]}], 
         RowBox[{"p21", " ", 
          SqrtBox[
           RowBox[{
            SuperscriptBox["p3z1z", "2"], "+", 
            SuperscriptBox[
             RowBox[{"Abs", "[", 
              FractionBox[
               RowBox[{
                RowBox[{
                 RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
                RowBox[{"p2x", " ", "p3y"}], "+", 
                RowBox[{"p3x", " ", "psq"}], "-", 
                RowBox[{"p1x", " ", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
               
               SqrtBox["p21"]], "]"}], "2"]}]]}]], "-", 
        RowBox[{"p1z", " ", 
         SqrtBox[
          RowBox[{"1", "-", 
           FractionBox[
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               RowBox[{"p1y", " ", "p2x"}], "-", 
               RowBox[{"p2x", " ", "p3y"}], "-", 
               RowBox[{"p3x", " ", "psq"}], "+", 
               RowBox[{"p1x", " ", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
              ")"}], "2"], 
            RowBox[{"p21", " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["p3z1z", "2"], "+", 
               SuperscriptBox[
                RowBox[{"Abs", "[", 
                 FractionBox[
                  RowBox[{
                   RowBox[{
                    RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
                   RowBox[{"p2x", " ", "p3y"}], "+", 
                   RowBox[{"p3x", " ", "psq"}], "-", 
                   RowBox[{"p1x", " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
                  SqrtBox["p21"]], "]"}], "2"]}], ")"}]}]]}]]}]}]},
      {
       RowBox[{
        RowBox[{"-", 
         SqrtBox[
          RowBox[{"1", "-", 
           FractionBox[
            SuperscriptBox["p2x1x", "2"], "p21"]}]]}], " ", 
        SqrtBox[
         RowBox[{"1", "-", 
          FractionBox[
           SuperscriptBox[
            RowBox[{"(", 
             RowBox[{
              RowBox[{"p1y", " ", "p2x"}], "-", 
              RowBox[{"p2x", " ", "p3y"}], "-", 
              RowBox[{"p3x", " ", "psq"}], "+", 
              RowBox[{"p1x", " ", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
             ")"}], "2"], 
           RowBox[{"p21", " ", 
            RowBox[{"(", 
             RowBox[{
              SuperscriptBox["p3z1z", "2"], "+", 
              SuperscriptBox[
               RowBox[{"Abs", "[", 
                FractionBox[
                 RowBox[{
                  RowBox[{
                   RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
                  RowBox[{"p2x", " ", "p3y"}], "+", 
                  RowBox[{"p3x", " ", "psq"}], "-", 
                  RowBox[{"p1x", " ", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
                 SqrtBox["p21"]], "]"}], "2"]}], ")"}]}]]}]]}], 
       FractionBox[
        RowBox[{"p2x1x", " ", 
         SqrtBox[
          RowBox[{"1", "-", 
           FractionBox[
            SuperscriptBox[
             RowBox[{"(", 
              RowBox[{
               RowBox[{"p1y", " ", "p2x"}], "-", 
               RowBox[{"p2x", " ", "p3y"}], "-", 
               RowBox[{"p3x", " ", "psq"}], "+", 
               RowBox[{"p1x", " ", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
              ")"}], "2"], 
            RowBox[{"p21", " ", 
             RowBox[{"(", 
              RowBox[{
               SuperscriptBox["p3z1z", "2"], "+", 
               SuperscriptBox[
                RowBox[{"Abs", "[", 
                 FractionBox[
                  RowBox[{
                   RowBox[{
                    RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
                   RowBox[{"p2x", " ", "p3y"}], "+", 
                   RowBox[{"p3x", " ", "psq"}], "-", 
                   RowBox[{"p1x", " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
                  SqrtBox["p21"]], "]"}], "2"]}], ")"}]}]]}]]}], 
        SqrtBox["p21"]], 
       FractionBox[
        RowBox[{
         RowBox[{
          RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
         RowBox[{"p2x", " ", "p3y"}], "+", 
         RowBox[{"p3x", " ", "psq"}], "-", 
         RowBox[{"p1x", " ", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
        SqrtBox[
         RowBox[{"p21", " ", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["p3z1z", "2"], "+", 
            SuperscriptBox[
             RowBox[{"Abs", "[", 
              FractionBox[
               RowBox[{
                RowBox[{
                 RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
                RowBox[{"p2x", " ", "p3y"}], "+", 
                RowBox[{"p3x", " ", "psq"}], "-", 
                RowBox[{"p1x", " ", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
               
               SqrtBox["p21"]], "]"}], "2"]}], ")"}]}]]], 
       RowBox[{
        FractionBox[
         RowBox[{"p1z", " ", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"p1y", " ", "p2x"}], "-", 
            RowBox[{"p2x", " ", "p3y"}], "-", 
            RowBox[{"p3x", " ", "psq"}], "+", 
            RowBox[{"p1x", " ", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
           ")"}]}], 
         SqrtBox[
          RowBox[{"p21", " ", 
           RowBox[{"(", 
            RowBox[{
             SuperscriptBox["p3z1z", "2"], "+", 
             SuperscriptBox[
              RowBox[{"Abs", "[", 
               FractionBox[
                RowBox[{
                 RowBox[{
                  RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
                 RowBox[{"p2x", " ", "p3y"}], "+", 
                 RowBox[{"p3x", " ", "psq"}], "-", 
                 RowBox[{"p1x", " ", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
                SqrtBox["p21"]], "]"}], "2"]}], ")"}]}]]], "+", 
        FractionBox[
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"p1y", " ", "p2x"}], "+", 
            RowBox[{"p1x", " ", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"-", "p1y"}], "+", "psq"}], ")"}]}]}], ")"}], " ", 
          SqrtBox[
           RowBox[{"1", "-", 
            FractionBox[
             SuperscriptBox[
              RowBox[{"(", 
               RowBox[{
                RowBox[{"p1y", " ", "p2x"}], "-", 
                RowBox[{"p2x", " ", "p3y"}], "-", 
                RowBox[{"p3x", " ", "psq"}], "+", 
                RowBox[{"p1x", " ", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
               ")"}], "2"], 
             RowBox[{"p21", " ", 
              RowBox[{"(", 
               RowBox[{
                SuperscriptBox["p3z1z", "2"], "+", 
                SuperscriptBox[
                 RowBox[{"Abs", "[", 
                  FractionBox[
                   RowBox[{
                    RowBox[{
                    RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
                    RowBox[{"p2x", " ", "p3y"}], "+", 
                    RowBox[{"p3x", " ", "psq"}], "-", 
                    RowBox[{"p1x", " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
                   SqrtBox["p21"]], "]"}], "2"]}], ")"}]}]]}]]}], 
         SqrtBox["p21"]]}]},
      {"0", "0", "0", "1"}
     },
     AutoDelete->False,
     GridBoxDividers->{
      "Columns" -> {{False}}, "ColumnsIndexed" -> {-2 -> True}, 
       "Rows" -> {{False}}, "RowsIndexed" -> {-2 -> True}},
     GridBoxItemSize->{"Columns" -> {{Automatic}}, "Rows" -> {{Automatic}}}],
    #& ], ")"}], "]"}]], "Output",
 CellChangeTimes->{3.68051643962358*^9, 3.680516503553872*^9, 
  3.680516612833427*^9}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["C code generation", "Chapter",
 CellChangeTimes->{{3.680518850048316*^9, 3.680518855670826*^9}}],

Cell["\<\
Let\[CloseCurlyQuote]s apply the TTs transformation to a generic {X,Y,Z} \
point:\
\>", "Text",
 CellChangeTimes->{{3.680518841922998*^9, 3.6805188851237803`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"coords", "=", 
  RowBox[{"TTs", "[", 
   RowBox[{"{", 
    RowBox[{"X", ",", "Y", ",", "Z"}], "}"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.680515913771165*^9, 3.680515969646092*^9}, {
  3.6805160238427877`*^9, 3.680516044753804*^9}, {3.680516099227186*^9, 
  3.680516145532996*^9}, {3.680516626548015*^9, 3.6805166759592743`*^9}, {
  3.680523337036319*^9, 3.6805234065256367`*^9}, {3.680523477304611*^9, 
  3.680523508453442*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{
    FractionBox[
     RowBox[{
      SuperscriptBox["p1x", "2"], "-", 
      RowBox[{"p1x", " ", "p2x"}], "+", 
      RowBox[{"p1y", " ", "psq"}]}], 
     SqrtBox["p21"]], "-", 
    FractionBox[
     RowBox[{"p2x1x", " ", "X"}], 
     SqrtBox["p21"]], "-", 
    RowBox[{
     SqrtBox[
      RowBox[{"1", "-", 
       FractionBox[
        SuperscriptBox["p2x1x", "2"], "p21"]}]], " ", "Y"}]}], ",", 
   RowBox[{
    FractionBox[
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"p1y", " ", "p2x"}], "+", 
        RowBox[{"p1x", " ", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"-", "p1y"}], "+", "psq"}], ")"}]}]}], ")"}], " ", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"p1y", " ", "p2x"}], "-", 
        RowBox[{"p2x", " ", "p3y"}], "-", 
        RowBox[{"p3x", " ", "psq"}], "+", 
        RowBox[{"p1x", " ", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], ")"}]}], 
     RowBox[{"p21", " ", 
      SqrtBox[
       RowBox[{
        SuperscriptBox["p3z1z", "2"], "+", 
        SuperscriptBox[
         RowBox[{"Abs", "[", 
          FractionBox[
           RowBox[{
            RowBox[{
             RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
            RowBox[{"p2x", " ", "p3y"}], "+", 
            RowBox[{"p3x", " ", "psq"}], "-", 
            RowBox[{"p1x", " ", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
           SqrtBox["p21"]], "]"}], "2"]}]]}]], "+", 
    FractionBox[
     RowBox[{"p2x1x", " ", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"p1y", " ", "p2x"}], "-", 
        RowBox[{"p2x", " ", "p3y"}], "-", 
        RowBox[{"p3x", " ", "psq"}], "+", 
        RowBox[{"p1x", " ", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], ")"}], 
      " ", "Y"}], 
     RowBox[{"p21", " ", 
      SqrtBox[
       RowBox[{
        SuperscriptBox["p3z1z", "2"], "+", 
        SuperscriptBox[
         RowBox[{"Abs", "[", 
          FractionBox[
           RowBox[{
            RowBox[{
             RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
            RowBox[{"p2x", " ", "p3y"}], "+", 
            RowBox[{"p3x", " ", "psq"}], "-", 
            RowBox[{"p1x", " ", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
           SqrtBox["p21"]], "]"}], "2"]}]]}]], "+", 
    FractionBox[
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
        RowBox[{"p2x", " ", "p3y"}], "+", 
        RowBox[{"p3x", " ", "psq"}], "-", 
        RowBox[{"p1x", " ", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], ")"}], 
      " ", "X"}], 
     SqrtBox[
      FractionBox[
       RowBox[{
        SuperscriptBox[
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["p1x", "2"], "+", 
           SuperscriptBox["p1y", "2"], "+", 
           SuperscriptBox["p1z", "2"], "-", 
           RowBox[{"2", " ", "p1x", " ", "p2x"}], "+", 
           SuperscriptBox["p2x", "2"], "-", 
           RowBox[{"2", " ", "p1y", " ", "p2y"}], "+", 
           SuperscriptBox["p2y", "2"], "-", 
           RowBox[{"2", " ", "p1z", " ", "p2z"}], "+", 
           SuperscriptBox["p2z", "2"]}], ")"}], "2"], " ", 
        RowBox[{"(", 
         RowBox[{
          SuperscriptBox["p3z1z", "2"], "+", 
          SuperscriptBox[
           RowBox[{"Abs", "[", 
            FractionBox[
             RowBox[{
              RowBox[{
               RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
              RowBox[{"p2x", " ", "p3y"}], "+", 
              RowBox[{"p3x", " ", "psq"}], "-", 
              RowBox[{"p1x", " ", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
             SqrtBox["p21"]], "]"}], "2"]}], ")"}]}], 
       RowBox[{
        SuperscriptBox["p1y", "2"], "+", 
        SuperscriptBox["p1z", "2"], "-", 
        RowBox[{"2", " ", "p1y", " ", "p2y"}], "+", 
        SuperscriptBox["p2y", "2"], "-", 
        RowBox[{"2", " ", "p1z", " ", "p2z"}], "+", 
        SuperscriptBox["p2z", "2"]}]]]], "-", 
    RowBox[{"p1z", " ", 
     SqrtBox[
      RowBox[{"1", "-", 
       FractionBox[
        SuperscriptBox[
         RowBox[{"(", 
          RowBox[{
           RowBox[{"p1y", " ", "p2x"}], "-", 
           RowBox[{"p2x", " ", "p3y"}], "-", 
           RowBox[{"p3x", " ", "psq"}], "+", 
           RowBox[{"p1x", " ", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
          ")"}], "2"], 
        RowBox[{"p21", " ", 
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["p3z1z", "2"], "+", 
           SuperscriptBox[
            RowBox[{"Abs", "[", 
             FractionBox[
              RowBox[{
               RowBox[{
                RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
               RowBox[{"p2x", " ", "p3y"}], "+", 
               RowBox[{"p3x", " ", "psq"}], "-", 
               RowBox[{"p1x", " ", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
              SqrtBox["p21"]], "]"}], "2"]}], ")"}]}]]}]]}], "+", 
    RowBox[{"Z", " ", 
     SqrtBox[
      RowBox[{"1", "-", 
       FractionBox[
        SuperscriptBox[
         RowBox[{"(", 
          RowBox[{
           RowBox[{"p1y", " ", "p2x"}], "-", 
           RowBox[{"p2x", " ", "p3y"}], "-", 
           RowBox[{"p3x", " ", "psq"}], "+", 
           RowBox[{"p1x", " ", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
          ")"}], "2"], 
        RowBox[{"p21", " ", 
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["p3z1z", "2"], "+", 
           SuperscriptBox[
            RowBox[{"Abs", "[", 
             FractionBox[
              RowBox[{
               RowBox[{
                RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
               RowBox[{"p2x", " ", "p3y"}], "+", 
               RowBox[{"p3x", " ", "psq"}], "-", 
               RowBox[{"p1x", " ", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
              SqrtBox["p21"]], "]"}], "2"]}], ")"}]}]]}]]}]}], ",", 
   RowBox[{
    FractionBox[
     RowBox[{"p1z", " ", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"p1y", " ", "p2x"}], "-", 
        RowBox[{"p2x", " ", "p3y"}], "-", 
        RowBox[{"p3x", " ", "psq"}], "+", 
        RowBox[{"p1x", " ", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], ")"}]}], 
     SqrtBox[
      RowBox[{"p21", " ", 
       RowBox[{"(", 
        RowBox[{
         SuperscriptBox["p3z1z", "2"], "+", 
         SuperscriptBox[
          RowBox[{"Abs", "[", 
           FractionBox[
            RowBox[{
             RowBox[{
              RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
             RowBox[{"p2x", " ", "p3y"}], "+", 
             RowBox[{"p3x", " ", "psq"}], "-", 
             RowBox[{"p1x", " ", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
            SqrtBox["p21"]], "]"}], "2"]}], ")"}]}]]], "+", 
    FractionBox[
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
        RowBox[{"p2x", " ", "p3y"}], "+", 
        RowBox[{"p3x", " ", "psq"}], "-", 
        RowBox[{"p1x", " ", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], ")"}], 
      " ", "Z"}], 
     SqrtBox[
      RowBox[{"p21", " ", 
       RowBox[{"(", 
        RowBox[{
         SuperscriptBox["p3z1z", "2"], "+", 
         SuperscriptBox[
          RowBox[{"Abs", "[", 
           FractionBox[
            RowBox[{
             RowBox[{
              RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
             RowBox[{"p2x", " ", "p3y"}], "+", 
             RowBox[{"p3x", " ", "psq"}], "-", 
             RowBox[{"p1x", " ", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
            SqrtBox["p21"]], "]"}], "2"]}], ")"}]}]]], "+", 
    FractionBox[
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"p1y", " ", "p2x"}], "+", 
        RowBox[{"p1x", " ", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"-", "p1y"}], "+", "psq"}], ")"}]}]}], ")"}], " ", 
      SqrtBox[
       RowBox[{"1", "-", 
        FractionBox[
         SuperscriptBox[
          RowBox[{"(", 
           RowBox[{
            RowBox[{"p1y", " ", "p2x"}], "-", 
            RowBox[{"p2x", " ", "p3y"}], "-", 
            RowBox[{"p3x", " ", "psq"}], "+", 
            RowBox[{"p1x", " ", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
           ")"}], "2"], 
         RowBox[{"p21", " ", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["p3z1z", "2"], "+", 
            SuperscriptBox[
             RowBox[{"Abs", "[", 
              FractionBox[
               RowBox[{
                RowBox[{
                 RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
                RowBox[{"p2x", " ", "p3y"}], "+", 
                RowBox[{"p3x", " ", "psq"}], "-", 
                RowBox[{"p1x", " ", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
               
               SqrtBox["p21"]], "]"}], "2"]}], ")"}]}]]}]]}], 
     SqrtBox["p21"]], "-", 
    RowBox[{
     SqrtBox[
      RowBox[{"1", "-", 
       FractionBox[
        SuperscriptBox["p2x1x", "2"], "p21"]}]], " ", "X", " ", 
     SqrtBox[
      RowBox[{"1", "-", 
       FractionBox[
        SuperscriptBox[
         RowBox[{"(", 
          RowBox[{
           RowBox[{"p1y", " ", "p2x"}], "-", 
           RowBox[{"p2x", " ", "p3y"}], "-", 
           RowBox[{"p3x", " ", "psq"}], "+", 
           RowBox[{"p1x", " ", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
          ")"}], "2"], 
        RowBox[{"p21", " ", 
         RowBox[{"(", 
          RowBox[{
           SuperscriptBox["p3z1z", "2"], "+", 
           SuperscriptBox[
            RowBox[{"Abs", "[", 
             FractionBox[
              RowBox[{
               RowBox[{
                RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
               RowBox[{"p2x", " ", "p3y"}], "+", 
               RowBox[{"p3x", " ", "psq"}], "-", 
               RowBox[{"p1x", " ", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
              SqrtBox["p21"]], "]"}], "2"]}], ")"}]}]]}]]}], "+", 
    FractionBox[
     RowBox[{"p2x1x", " ", "Y", " ", 
      SqrtBox[
       RowBox[{"1", "-", 
        FractionBox[
         SuperscriptBox[
          RowBox[{"(", 
           RowBox[{
            RowBox[{"p1y", " ", "p2x"}], "-", 
            RowBox[{"p2x", " ", "p3y"}], "-", 
            RowBox[{"p3x", " ", "psq"}], "+", 
            RowBox[{"p1x", " ", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
           ")"}], "2"], 
         RowBox[{"p21", " ", 
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["p3z1z", "2"], "+", 
            SuperscriptBox[
             RowBox[{"Abs", "[", 
              FractionBox[
               RowBox[{
                RowBox[{
                 RowBox[{"-", "p1y"}], " ", "p2x"}], "+", 
                RowBox[{"p2x", " ", "p3y"}], "+", 
                RowBox[{"p3x", " ", "psq"}], "-", 
                RowBox[{"p1x", " ", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"-", "p1y"}], "+", "p3y", "+", "psq"}], ")"}]}]}], 
               
               SqrtBox["p21"]], "]"}], "2"]}], ")"}]}]]}]]}], 
     SqrtBox["p21"]]}]}], "}"}]], "Output",
 CellChangeTimes->{{3.680515931159046*^9, 3.680515970319158*^9}, {
   3.680516033813797*^9, 3.680516045987493*^9}, 3.680516146457004*^9, {
   3.6805166409316807`*^9, 3.680516676692367*^9}, {3.680523340399345*^9, 
   3.680523374595524*^9}, 3.6805234085744257`*^9, 3.68052347844438*^9, 
   3.680523510066864*^9, 3.680523988459366*^9}]
}, Open  ]],

Cell["Now, let\[CloseCurlyQuote]s generate the C code for the three \
coordinates:", "Text",
 CellChangeTimes->{{3.6805188954077177`*^9, 3.680518912810919*^9}}],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"\"\<Xt = \>\"", "<>", " ", 
   RowBox[{"ToString", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"TTs", "[", 
       RowBox[{"{", 
        RowBox[{"X", ",", "Y", ",", "Z"}], "}"}], "]"}], 
      "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], ",", " ", 
     "CForm"}], "]"}], "<>", "\"\<;\\n\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{" ", 
  RowBox[{
   RowBox[{"%", "<>", "\"\<Yt = \>\"", "<>", 
    RowBox[{"ToString", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"TTs", "[", 
        RowBox[{"{", 
         RowBox[{"X", ",", "Y", ",", "Z"}], "}"}], "]"}], 
       "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], ",", " ", 
      "CForm"}], "]"}], "<>", "\"\<;\\n\>\""}], 
   ";"}]}], "\[IndentingNewLine]", 
 RowBox[{" ", 
  RowBox[{"%", "<>", "\"\<Zt = \>\"", "<>", 
   RowBox[{"ToString", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"TTs", "[", 
       RowBox[{"{", 
        RowBox[{"X", ",", "Y", ",", "Z"}], "}"}], "]"}], 
      "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}], ",", " ", 
     "CForm"}], "]"}], "<>", "\"\<;\\n\>\""}]}]}], "Input",
 CellChangeTimes->{{3.680516732709072*^9, 3.68051673506392*^9}, {
  3.680516766935437*^9, 3.6805168219215117`*^9}, {3.680516906508892*^9, 
  3.6805169152265873`*^9}, {3.6805242979738092`*^9, 3.680524440761509*^9}, {
  3.680525305800926*^9, 3.680525307848487*^9}, {3.680525455315522*^9, 
  3.6805254607165737`*^9}}],

Cell[BoxData["\<\"Xt = (Power(p1x,2) - p1x*p2x + p1y*psq)/Sqrt(p21) - \
(p2x1x*X)/Sqrt(p21) - Sqrt(1 - Power(p2x1x,2)/p21)*Y;\\nYt = ((p1y*p2x + \
p1x*(-p1y + psq))*(p1y*p2x - p2x*p3y - p3x*psq + p1x*(-p1y + p3y + \
psq)))/(p21*Sqrt(Power(p3z1z,2) + Power(Abs((-(p1y*p2x) + p2x*p3y + p3x*psq - \
p1x*(-p1y + p3y + psq))/Sqrt(p21)),2))) + (p2x1x*(p1y*p2x - p2x*p3y - p3x*psq \
+ p1x*(-p1y + p3y + psq))*Y)/(p21*Sqrt(Power(p3z1z,2) + Power(Abs((-(p1y*p2x) \
+ p2x*p3y + p3x*psq - p1x*(-p1y + p3y + psq))/Sqrt(p21)),2))) + ((-(p1y*p2x) \
+ p2x*p3y + p3x*psq - p1x*(-p1y + p3y + psq))*X)/Sqrt((Power(Power(p1x,2) + \
Power(p1y,2) + Power(p1z,2) - 2*p1x*p2x + Power(p2x,2) - 2*p1y*p2y + \
Power(p2y,2) - 2*p1z*p2z + Power(p2z,2),2)*(Power(p3z1z,2) + \
Power(Abs((-(p1y*p2x) + p2x*p3y + p3x*psq - p1x*(-p1y + p3y + \
psq))/Sqrt(p21)),2)))/(Power(p1y,2) + Power(p1z,2) - 2*p1y*p2y + Power(p2y,2) \
- 2*p1z*p2z + Power(p2z,2))) - p1z*Sqrt(1 - Power(p1y*p2x - p2x*p3y - p3x*psq \
+ p1x*(-p1y + p3y + psq),2)/(p21*(Power(p3z1z,2) + Power(Abs((-(p1y*p2x) + \
p2x*p3y + p3x*psq - p1x*(-p1y + p3y + psq))/Sqrt(p21)),2)))) + Z*Sqrt(1 - \
Power(p1y*p2x - p2x*p3y - p3x*psq + p1x*(-p1y + p3y + \
psq),2)/(p21*(Power(p3z1z,2) + Power(Abs((-(p1y*p2x) + p2x*p3y + p3x*psq - \
p1x*(-p1y + p3y + psq))/Sqrt(p21)),2))));\\nZt = (p1z*(p1y*p2x - p2x*p3y - \
p3x*psq + p1x*(-p1y + p3y + psq)))/Sqrt(p21*(Power(p3z1z,2) + \
Power(Abs((-(p1y*p2x) + p2x*p3y + p3x*psq - p1x*(-p1y + p3y + \
psq))/Sqrt(p21)),2))) + ((-(p1y*p2x) + p2x*p3y + p3x*psq - p1x*(-p1y + p3y + \
psq))*Z)/Sqrt(p21*(Power(p3z1z,2) + Power(Abs((-(p1y*p2x) + p2x*p3y + p3x*psq \
- p1x*(-p1y + p3y + psq))/Sqrt(p21)),2))) + ((p1y*p2x + p1x*(-p1y + \
psq))*Sqrt(1 - Power(p1y*p2x - p2x*p3y - p3x*psq + p1x*(-p1y + p3y + \
psq),2)/(p21*(Power(p3z1z,2) + Power(Abs((-(p1y*p2x) + p2x*p3y + p3x*psq - \
p1x*(-p1y + p3y + psq))/Sqrt(p21)),2)))))/Sqrt(p21) - Sqrt(1 - \
Power(p2x1x,2)/p21)*X*Sqrt(1 - Power(p1y*p2x - p2x*p3y - p3x*psq + p1x*(-p1y \
+ p3y + psq),2)/(p21*(Power(p3z1z,2) + Power(Abs((-(p1y*p2x) + p2x*p3y + \
p3x*psq - p1x*(-p1y + p3y + psq))/Sqrt(p21)),2)))) + (p2x1x*Y*Sqrt(1 - \
Power(p1y*p2x - p2x*p3y - p3x*psq + p1x*(-p1y + p3y + \
psq),2)/(p21*(Power(p3z1z,2) + Power(Abs((-(p1y*p2x) + p2x*p3y + p3x*psq - \
p1x*(-p1y + p3y + psq))/Sqrt(p21)),2)))))/Sqrt(p21);\\n\"\>"], "Output",
 CellChangeTimes->{
  3.6805168418942947`*^9, {3.680516908982044*^9, 3.6805169160619917`*^9}, {
   3.6805243246760178`*^9, 3.680524373395739*^9}, {3.68052441476621*^9, 
   3.6805244433694468`*^9}, 3.680525309098633*^9, 3.680525471543971*^9}]
}, Open  ]],

Cell["\<\
The only thing that\[CloseCurlyQuote]s missing now is the code representing \
the set of rules used for simplifying the expression:\
\>", "Text",
 CellChangeTimes->{{3.6805189232168713`*^9, 3.680518954155384*^9}}],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"rules", "/.", " ", 
   RowBox[{
    RowBox[{"HoldPattern", "[", 
     RowBox[{"a_", "\[Rule]", "b_"}], "]"}], " ", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", "b", "}"}], ",", 
      RowBox[{"{", "a", "}"}]}], "}"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"rparts", "=", 
  RowBox[{"Apply", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"ToString", "[", 
      RowBox[{"#", ",", "CForm"}], "]"}], "&"}], ",", " ", "%", ",", " ", 
    RowBox[{"{", "2", "}"}]}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.6805171810760736`*^9, 3.680517196908794*^9}, {
   3.680517229658133*^9, 3.680517242010722*^9}, {3.680517442063219*^9, 
   3.680517453458228*^9}, {3.680517483463866*^9, 3.680517517190979*^9}, {
   3.680517575402288*^9, 3.680517588146268*^9}, {3.680519170410839*^9, 
   3.680519334121273*^9}, {3.680519371472104*^9, 3.6805193840717297`*^9}, {
   3.6805194269707327`*^9, 3.680519429196887*^9}, {3.6805194703067293`*^9, 
   3.68051947113752*^9}, {3.680519609729042*^9, 3.680519610662447*^9}, {
   3.680519643840981*^9, 3.6805196544152946`*^9}, {3.680519732729156*^9, 
   3.6805197677264977`*^9}, {3.680519801062408*^9, 3.680519805583221*^9}, {
   3.680519874953183*^9, 3.680519890218712*^9}, {3.680519944332975*^9, 
   3.680520015073371*^9}, {3.6805200459812098`*^9, 3.6805200824171963`*^9}, {
   3.6805201124225903`*^9, 3.6805201178216953`*^9}, {3.6805202987255898`*^9, 
   3.68052030253971*^9}, {3.680520609131083*^9, 3.680520657797782*^9}, {
   3.680520763742194*^9, 3.680520764191395*^9}, 3.6805209359936733`*^9, {
   3.6805210052385798`*^9, 3.680521006194029*^9}, {3.68052108661147*^9, 
   3.680521087589737*^9}, {3.6805226655003347`*^9, 3.680522682881522*^9}, {
   3.6805252463547792`*^9, 3.6805252484109697`*^9}, 3.680525462706873*^9}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"\<\"p1x2x\"\>", ",", "\<\"p1x + p2x\"\>"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"\<\"p2x1x\"\>", ",", "\<\"p1x - p2x\"\>"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"\<\"-p2x1x\"\>", ",", "\<\"-p1x + p2x\"\>"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"\<\"p1y2y\"\>", ",", "\<\"p1y + p2y\"\>"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"\<\"p2y1y\"\>", ",", "\<\"p1y - p2y\"\>"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"\<\"-p2y1y\"\>", ",", "\<\"-p1y + p2y\"\>"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"\<\"p1z2z\"\>", ",", "\<\"p1z + p2z\"\>"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"\<\"p2z1z\"\>", ",", "\<\"p1z - p2z\"\>"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"\<\"-p2z1z\"\>", ",", "\<\"-p1z + p2z\"\>"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"\<\"p21\"\>", 
     ",", "\<\"Power(p2x1x,2) + Power(p2y1y,2) + Power(p2z1z,2)\"\>"}], "}"}],
    ",", 
   RowBox[{"{", 
    RowBox[{"\<\"p3z1z\"\>", ",", "\<\"p1z - p3z\"\>"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"\<\"-p3z1z\"\>", ",", "\<\"-p1z + p3z\"\>"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"\<\"psq\"\>", 
     ",", "\<\"Sqrt(Power(p1y,2) + Power(p1z,2) - 2*p1y*p2y + Power(p2y,2) - \
2*p1z*p2z + Power(p2z,2))\"\>"}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{
  3.6805209363086853`*^9, 3.680521006984078*^9, 3.680521088066505*^9, {
   3.68052267527857*^9, 3.680522685096283*^9}, 3.680524493491878*^9, {
   3.680525250991354*^9, 3.680525277259371*^9}, 3.680525465510359*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"Apply", "[", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"StringTemplate", "[", "\"\<`` = ``;\>\"", "]"}], "[", 
      RowBox[{"#1", ",", "#2"}], "]"}], "&"}], ",", "rparts", ",", 
    RowBox[{"{", "1", "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Row", "[", 
  RowBox[{"%", ",", "\"\<\\n\>\""}], "]"}]}], "Input",
 CellChangeTimes->{{3.6805223309553843`*^9, 3.680522457629376*^9}, {
  3.680522628621615*^9, 3.680522633288886*^9}, {3.680524488697391*^9, 
  3.68052448976437*^9}, {3.680525284829358*^9, 3.680525285187552*^9}}],

Cell[BoxData[
 TemplateBox[{
  "\n","\"\\n\"","\"p1x2x = p1x + p2x;\"","\"p2x1x = p1x - p2x;\"",
   "\"-p2x1x = -p1x + p2x;\"","\"p1y2y = p1y + p2y;\"",
   "\"p2y1y = p1y - p2y;\"","\"-p2y1y = -p1y + p2y;\"",
   "\"p1z2z = p1z + p2z;\"","\"p2z1z = p1z - p2z;\"",
   "\"-p2z1z = -p1z + p2z;\"",
   "\"p21 = Power(p2x1x,2) + Power(p2y1y,2) + Power(p2z1z,2);\"",
   "\"p3z1z = p1z - p3z;\"","\"-p3z1z = -p1z + p3z;\"",
   "\"psq = Sqrt(Power(p1y,2) + Power(p1z,2) - 2*p1y*p2y + Power(p2y,2) - \
2*p1z*p2z + Power(p2z,2));\""},
  "RowWithSeparators"]], "Output",
 CellChangeTimes->{{3.68052242310878*^9, 3.680522460292264*^9}, {
   3.680522629843586*^9, 3.6805226338945007`*^9}, 3.680522694633131*^9, 
   3.6805244951257153`*^9, {3.680525263928933*^9, 3.680525287379468*^9}, 
   3.680525469016217*^9}]
}, Open  ]],

Cell[TextData[StyleBox["Just pay attention to remove the inverse rules!",
 FontWeight->"Bold"]], "Text",
 CellChangeTimes->{{3.680524590812296*^9, 3.680524602466028*^9}}]
}, Open  ]]
}, Open  ]]
},
WindowToolbars->"EditBar",
WindowSize->{1967, 1331},
WindowMargins->{{77, Automatic}, {Automatic, 0}},
FrontEndVersion->"11.0 for Mac OS X x86 (32-bit, 64-bit Kernel) (July 28, \
2016)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 109, 1, 92, "Title"],
Cell[692, 25, 723, 11, 68, "Text"],
Cell[CellGroupData[{
Cell[1440, 40, 96, 1, 65, "Chapter"],
Cell[1539, 43, 1608, 38, 96, "Input"],
Cell[3150, 83, 547, 14, 32, "Input"],
Cell[CellGroupData[{
Cell[3722, 101, 1064, 22, 32, "Input"],
Cell[4789, 125, 1403, 27, 345, "Output"]
}, Open  ]],
Cell[6207, 155, 562, 10, 106, "Text"],
Cell[CellGroupData[{
Cell[6794, 169, 4536, 118, 369, "Input"],
Cell[11333, 289, 2061, 43, 631, "Output"],
Cell[13397, 334, 950, 21, 35, "Output"],
Cell[14350, 357, 1325, 30, 92, "Output"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[15724, 393, 98, 1, 65, "Chapter"],
Cell[15825, 396, 156, 3, 30, "Text"],
Cell[15984, 401, 2615, 76, 159, "Input"],
Cell[18602, 479, 140, 1, 30, "Text"],
Cell[CellGroupData[{
Cell[18767, 484, 2956, 76, 222, "Input"],
Cell[21726, 562, 1797, 38, 313, "Output"]
}, Open  ]],
Cell[23538, 603, 490, 10, 50, "Text"],
Cell[CellGroupData[{
Cell[24053, 617, 3057, 79, 207, "Input"],
Cell[27113, 698, 14200, 386, 373, "Output"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[41362, 1090, 102, 1, 65, "Chapter"],
Cell[41467, 1093, 173, 4, 30, "Text"],
Cell[CellGroupData[{
Cell[41665, 1101, 457, 9, 32, "Input"],
Cell[42125, 1112, 12830, 376, 452, "Output"]
}, Open  ]],
Cell[54970, 1491, 160, 2, 30, "Text"],
Cell[CellGroupData[{
Cell[55155, 1497, 1445, 37, 75, "Input"],
Cell[56603, 1536, 2578, 35, 285, "Output"]
}, Open  ]],
Cell[59196, 1574, 223, 4, 30, "Text"],
Cell[CellGroupData[{
Cell[59444, 1582, 1799, 33, 54, "Input"],
Cell[61246, 1617, 1557, 36, 54, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[62840, 1658, 583, 13, 54, "Input"],
Cell[63426, 1673, 797, 15, 285, "Output"]
}, Open  ]],
Cell[64238, 1691, 170, 2, 30, "Text"]
}, Open  ]]
}, Open  ]]
}
]
*)

